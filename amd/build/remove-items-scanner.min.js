define("local_equipment/remove-items-scanner",["exports","local_equipment/universal-scanner","core/notification","core/log","local_equipment/jsqr","core/ajax","local_equipment/debug-utils"],(function(_exports,_universalScanner,_notification,_log,_jsqr,_ajax,_debugUtils){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Scanner integration for remove items page.
   *
   * @module     local_equipment/remove-items-scanner
   * @copyright  2024 onwards Joshua Kirby <josh@funlearningcompany.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_universalScanner=_interopRequireDefault(_universalScanner),_notification=_interopRequireDefault(_notification),_log=_interopRequireDefault(_log),_jsqr=_interopRequireDefault(_jsqr),_ajax=_interopRequireDefault(_ajax);function initializeScanner(){_log.default.debug("local_equipment/remove-items-scanner: initializeScanner() called");const scannerContainer=document.getElementById("scanner-container"),manualUuid=document.getElementById("manual_uuid"),lookupBtn=document.getElementById("lookup_btn"),sessionItems=document.getElementById("session_items");_log.default.debug("DOM elements found:",{scannerContainer:!!scannerContainer,manualUuid:!!manualUuid,lookupBtn:!!lookupBtn,sessionItems:!!sessionItems});let scanner=null,sessionRemovedCount=0,sessionRemovedItems=[];function initScanner(){if(!scannerContainer)return void _log.default.error("Scanner container not found in DOM");scannerContainer.innerHTML="";const controlsDiv=document.createElement("div");controlsDiv.className="scanner-controls",controlsDiv.innerHTML='\n            <div class="scanner-area mb-3" id="scanner-area">\n                \x3c!-- Scanner video will be inserted here --\x3e\n            </div>\n            <div class="scanner-toggle mb-3">\n                <div class="btn-group" role="group">\n                    <button type="button" id="start-camera-btn" class="btn btn-primary">\n                        <i class="fa fa-camera"></i> Start Camera\n                    </button>\n                    <button type="button" id="stop-camera-btn" class="btn btn-secondary" disabled>\n                        <i class="fa fa-stop"></i> Stop Camera\n                    </button>\n                </div>\n                <div class="mt-2">\n                    <button type="button" id="scan-barcode-btn" class="btn btn-primary" style="display: none;">\n                        <i class="fa fa-qrcode"></i> Scan\n                    </button>\n                    <button type="button" id="flip-camera-btn" class="btn btn-outline-secondary btn-sm ms-2" style="display: none;"\n                        title="Toggle camera mirror">\n                        <i class="fa fa-arrows-h"></i> Flip\n                    </button>\n                </div>\n            </div>\n            <div class="file-upload-section mb-3" style="display: none;" id="file-upload-section">\n                <label for="barcode-file-input" class="form-label">\n                    <i class="fa fa-camera"></i> Take Photo of Barcode/QR Code:\n                </label>\n                <div class="input-group">\n                    <input type="file" id="barcode-file-input" class="form-control" accept="image/*" capture="environment">\n                    <button type="button" id="process-file-btn" class="btn btn-outline-success" disabled>\n                        <i class="fa fa-search"></i> Scan Photo\n                    </button>\n                </div>\n                <small class="form-text text-muted">\n                    Take a clear photo of the QR code or barcode with good lighting\n                </small>\n            </div>\n            <div class="manual-input">\n                <label for="scanner-manual-input" class="form-label">Or enter barcode/QR manually:</label>\n                <div class="input-group">\n                    <input type="text" id="scanner-manual-input" class="form-control" placeholder="Scan or type barcode/QR code...">\n                    <button type="button" id="scanner-manual-btn" class="btn btn-outline-primary">Process</button>\n                </div>\n            </div>\n        ',scannerContainer.appendChild(controlsDiv),scanner=new _universalScanner.default({containerId:"scanner-area",resultCallback:handleScanResult,errorCallback:handleScanError}),scanner.init().then((success=>{success?_log.default.debug("Scanner initialized successfully"):(_log.default.error("Scanner initialization failed"),showFallbackInterface())})),function(){const startBtn=document.getElementById("start-camera-btn"),stopBtn=document.getElementById("stop-camera-btn"),scanBtn=document.getElementById("scan-barcode-btn"),flipBtn=document.getElementById("flip-camera-btn"),manualInput=document.getElementById("scanner-manual-input"),manualBtn=document.getElementById("scanner-manual-btn");let isScanning=!1,scanTimeout=null,isMirrored=!1;function updateVideoMirror(){const videoElement=document.querySelector("#scanner-area video");videoElement?(videoElement.style.transform=isMirrored?"scaleX(-1)":"scaleX(1)",_log.default.debug("Video mirror updated:",isMirrored?"mirrored (scaleX(-1))":"normal (scaleX(1))","Video element found:",!!videoElement,"Applied transform:",videoElement.style.transform)):_log.default.error("Video element not found for mirror update")}async function performSingleScan(){return new Promise((resolve=>{let scanAttempts=0;const maxAttempts=30;let found=!1;const scanFrame=async()=>{if(found||scanAttempts>=maxAttempts)resolve(found);else{try{if(!scanner.video||scanner.video.readyState!==scanner.video.HAVE_ENOUGH_DATA)return scanAttempts++,void requestAnimationFrame(scanFrame);if(scanner.context.drawImage(scanner.video,0,0,scanner.canvas.width,scanner.canvas.height),scanner.hasBarcodeDetector)try{const detector=new BarcodeDetector({formats:["qr_code","ean_13","ean_8","upc_a","upc_e","code_128","code_39"]}),barcodes=await detector.detect(scanner.canvas);if(barcodes.length>0){const barcode=barcodes[0];return _log.default.debug("Barcode detected:",barcode.rawValue,barcode.format),processBarcode(barcode.rawValue,barcode.format),found=!0,void resolve(!0)}}catch(error){_log.default.debug("BarcodeDetector failed:",error)}try{const imageData=scanner.context.getImageData(0,0,scanner.canvas.width,scanner.canvas.height),code=_jsqr.default.scan(imageData.data,imageData.width,imageData.height);if(code&&code.data)return _log.default.debug("QR code detected:",code.data),processBarcode(code.data,"qr_code"),found=!0,void resolve(!0)}catch(error){_log.default.debug("QR detection failed:",error)}}catch(error){_log.default.debug("Frame processing error:",error)}scanAttempts++,requestAnimationFrame(scanFrame)}};requestAnimationFrame(scanFrame)}))}startBtn.addEventListener("click",(async()=>{try{scanner.stream=await getCameraStreamRobust(),scanner.video.srcObject=scanner.stream,await scanner.video.play(),scanner.canvas.width=scanner.video.videoWidth,scanner.canvas.height=scanner.video.videoHeight,scanner.updateStatus("Camera ready - click Scan to detect barcode/QR code"),startBtn.disabled=!0,stopBtn.disabled=!1,scanBtn.style.display="inline-block",flipBtn.style.display="inline-block",updateVideoMirror(),updateStatusMessage("Camera started. Click 'Scan' to detect QR codes or barcodes in the camera view.","info")}catch(error){_log.default.error("Failed to start camera:",error);const compatibility=await checkCameraCompatibility();compatibility.supported?_notification.default.addNotification({message:"Failed to start camera: "+error.message,type:"error"}):showDetailedCompatibilityError(compatibility)}})),stopBtn.addEventListener("click",(()=>{scanner.stream&&(scanner.stream.getTracks().forEach((track=>track.stop())),scanner.stream=null),scanner.video&&(scanner.video.srcObject=null),scanner.updateStatus("Camera stopped"),startBtn.disabled=!1,stopBtn.disabled=!0,scanBtn.style.display="none",flipBtn.style.display="none",scanTimeout&&(clearTimeout(scanTimeout),scanTimeout=null),isScanning=!1})),flipBtn.addEventListener("click",(()=>{isMirrored=!isMirrored,updateVideoMirror();const icon="fa-arrows-h",text=isMirrored?"Flip (Mirrored)":"Flip (Normal)";flipBtn.innerHTML='<i class="fa '.concat(icon,'"></i> ').concat(text);showSuccessMessage(isMirrored?"Camera mirrored (good for webcams)":"Camera normal (good for mobile)")})),scanBtn.addEventListener("click",(async()=>{if(!isScanning){isScanning=!0,scanBtn.disabled=!0,scanBtn.innerHTML='<i class="fa fa-spinner fa-spin"></i> Scanning...',scanner.updateStatus("Scanning for barcode/QR code...");try{await performSingleScan()?(scanner.updateStatus("Scan successful!"),scanner.showScanSuccess()):(scanner.updateStatus("No barcode detected - try again"),showErrorMessage("No barcode detected. Please position the barcode/QR code in the target area and try again."))}catch(error){_log.default.error("Scan error:",error),scanner.updateStatus("Scan failed"),showErrorMessage("Scan failed. Please try again.")}isScanning=!1,scanBtn.disabled=!1,scanBtn.innerHTML='<i class="fa fa-qrcode"></i> Scan',setTimeout((()=>{scanner.updateStatus("Ready to scan - position barcode/QR code and click Scan")}),2e3)}})),manualBtn.addEventListener("click",(()=>{const barcode=manualInput.value.trim();barcode&&(processBarcode(barcode,"manual"),manualInput.value="")})),manualInput.addEventListener("keypress",(e=>{"Enter"===e.key&&manualBtn.click()})),function(){const fileInput=document.getElementById("barcode-file-input"),processFileBtn=document.getElementById("process-file-btn");if(!fileInput||!processFileBtn)return;fileInput.addEventListener("change",(function(){processFileBtn.disabled=!this.files.length})),processFileBtn.addEventListener("click",(async function(){const file=fileInput.files[0];if(!file)return;const originalText=this.innerHTML;this.disabled=!0,this.innerHTML='<i class="fa fa-spinner fa-spin"></i> Scanning Photo...';try{const barcode=await async function(file){return new Promise(((resolve,reject)=>{const reader=new FileReader;reader.onload=function(e){const img=new Image;img.onload=async function(){try{const canvas=document.createElement("canvas"),context=canvas.getContext("2d",{willReadFrequently:!0});if(canvas.width=img.width,canvas.height=img.height,context.drawImage(img,0,0),"BarcodeDetector"in window)try{const detector=new BarcodeDetector({formats:["qr_code","ean_13","ean_8","upc_a","upc_e","code_128","code_39"]}),barcodes=await detector.detect(canvas);if(barcodes.length>0)return _log.default.debug("Barcode detected from file:",barcodes[0].rawValue),void resolve({data:barcodes[0].rawValue,format:barcodes[0].format})}catch(error){_log.default.debug("BarcodeDetector failed on file:",error)}try{const imageData=context.getImageData(0,0,canvas.width,canvas.height),code=_jsqr.default.scan(imageData.data,imageData.width,imageData.height);if(code&&code.data)return _log.default.debug("QR code detected from file:",code.data),void resolve({data:code.data,format:"qr_code"})}catch(error){_log.default.debug("jsQR failed on file:",error)}resolve(null)}catch(error){reject(error)}},img.onerror=function(){reject(new Error("Failed to load image"))},img.src=e.target.result},reader.onerror=function(){reject(new Error("Failed to read file"))},reader.readAsDataURL(file)}))}(file);barcode?(showSuccessMessage("Barcode detected from photo!"),processBarcode(barcode.data,barcode.format||"file_upload"),fileInput.value=""):showErrorMessage("No barcode found in the image. Please try taking a clearer photo with better lighting.")}catch(error){_log.default.error("File processing error:",error),showErrorMessage("Failed to process image. Please try again.")}this.disabled=!1,this.innerHTML=originalText,processFileBtn.disabled=!0}))}()}(),function(){const scannerControls=document.querySelector(".scanner-controls");if(scannerControls&&!document.getElementById("test-network-btn")){const testButton=document.createElement("button");testButton.id="test-network-btn",testButton.type="button",testButton.className="btn btn-outline-info btn-sm mt-2",testButton.innerHTML='<i class="fa fa-wifi"></i> Test Network',testButton.addEventListener("click",(async function(){const originalText=this.innerHTML;this.disabled=!0,this.innerHTML='<i class="fa fa-spinner fa-spin"></i> Testing...';await async function(){try{const testUrl=M.cfg.wwwroot+"/local/equipment/classes/external/validate_removal.php";_log.default.debug("Testing network connectivity to:",testUrl);const response=await fetch(testUrl,{method:"OPTIONS",headers:{Accept:"application/json"}});return _log.default.debug("Network test response:",{status:response.status,ok:response.ok,headers:Object.fromEntries(response.headers.entries())}),response.ok}catch(error){return _log.default.error("Network connectivity test failed:",error),!1}}()?showSuccessMessage("Network connectivity test passed!"):showErrorMessage("Network connectivity test failed. Check your connection."),this.disabled=!1,this.innerHTML=originalText})),scannerControls.appendChild(testButton)}}()}function handleScanResult(result){if(result.success&&result.data){const barcodeData=result.data.barcode_data||result.data;_log.default.debug("Scan successful, processing barcode:",barcodeData),processBarcode(barcodeData,"scan")}else{_log.default.error("Scan failed:",result);showErrorMessage(result.message||"Scan failed. Please try again.")}}function handleScanError(errorCode,message){_log.default.error("Scanner error:",errorCode,message),"camera_access_failed"===errorCode&&showFallbackInterface()}function showFallbackInterface(){if(scannerContainer){const isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),isHTTP="http:"===window.location.protocol;let content="";content=isMobile&&isHTTP?'\n                    <div class="alert alert-info">\n                        <h5><i class="fa fa-mobile"></i> Mobile Camera Setup Required</h5>\n                        <p><strong>To enable camera scanning on mobile:</strong></p>\n                        <ol class="text-start mb-3">\n                            <li>Open Chrome menu (⋮) → <strong>Settings</strong></li>\n                            <li>Go to <strong>Site Settings</strong> → <strong>Camera</strong></li>\n                            <li>Find this site and set to <strong>"Allow"</strong></li>\n                        </ol>\n                        <p><strong>Alternative:</strong> In Chrome address bar, type:<br>\n                        <code>chrome://flags/#unsafely-treat-insecure-origin-as-secure</code><br>\n                        Add: <code>'.concat(window.location.origin,'</code></p>\n                        <button type="button" id="test-camera-btn" class="btn btn-primary btn-sm mt-2">\n                            <i class="fa fa-camera"></i> Test Camera Access\n                        </button>\n                    </div>\n                '):isMobile?'\n                    <div class="alert alert-warning text-center">\n                        <i class="fa fa-mobile"></i>\n                        <strong>Camera access denied</strong><br>\n                        Please check your browser settings and allow camera access for this site.\n                        <button type="button" id="test-camera-btn" class="btn btn-primary btn-sm mt-2">\n                            <i class="fa fa-camera"></i> Test Camera Access\n                        </button>\n                    </div>\n                ':'\n                    <div class="alert alert-warning text-center">\n                        <i class="fa fa-exclamation-triangle"></i>\n                        <strong>Camera not available</strong><br>\n                        Please use the manual input below to enter barcodes/QR codes.\n                    </div>\n                ',scannerContainer.innerHTML=content;const testBtn=document.getElementById("test-camera-btn");if(testBtn&&testBtn.addEventListener("click",testCameraAccess),isMobile){const fileUploadSection=document.getElementById("file-upload-section");fileUploadSection&&(fileUploadSection.style.display="block")}}}async function testCameraAccess(){const testBtn=document.getElementById("test-camera-btn"),originalText=testBtn.innerHTML;testBtn.disabled=!0,testBtn.innerHTML='<i class="fa fa-spinner fa-spin"></i> Testing...';const compatibility=await checkCameraCompatibility();if(!compatibility.supported)return showDetailedCompatibilityError(compatibility),testBtn.disabled=!1,void(testBtn.innerHTML=originalText);try{(await getCameraStreamRobust()).getTracks().forEach((track=>track.stop())),showSuccessMessage("Camera access granted! You can now use the Start Camera button."),initScanner()}catch(error){let errorMessage="Camera access failed. ";"NotAllowedError"===error.name?errorMessage+="Please allow camera permissions in your browser settings.":"NotFoundError"===error.name?errorMessage+="No camera found on this device.":"NotSupportedError"===error.name?errorMessage+="Camera not supported on this browser/device.":"NotReadableError"===error.name?errorMessage+="Camera is being used by another application.":errorMessage+="Error: ".concat(error.message),showErrorMessage(errorMessage),testBtn.disabled=!1,testBtn.innerHTML=originalText}}async function checkCameraCompatibility(){const result={supported:!1,method:null,issues:[],browserInfo:getBrowserInfo(),apis:{mediaDevices:!1,getUserMedia:!1,webkitGetUserMedia:!1,mozGetUserMedia:!1}};return _log.default.debug("Browser info:",result.browserInfo),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&(result.apis.mediaDevices=!0,result.method="mediaDevices",result.supported=!0),navigator.getUserMedia&&(result.apis.getUserMedia=!0,result.supported||(result.method="getUserMedia",result.supported=!0)),navigator.webkitGetUserMedia&&(result.apis.webkitGetUserMedia=!0,result.supported||(result.method="webkitGetUserMedia",result.supported=!0)),navigator.mozGetUserMedia&&(result.apis.mozGetUserMedia=!0,result.supported||(result.method="mozGetUserMedia",result.supported=!0)),"https:"!==location.protocol&&"localhost"!==location.hostname&&result.issues.push("insecure_context"),result.browserInfo.mobile&&!result.supported&&result.issues.push("mobile_no_camera_api"),_log.default.debug("Camera compatibility check:",result),result}function getBrowserInfo(){const ua=navigator.userAgent,result={mobile:/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua),chrome:/Chrome/i.test(ua),firefox:/Firefox/i.test(ua),safari:/Safari/i.test(ua)&&!/Chrome/i.test(ua),edge:/Edge/i.test(ua),version:null,android:/Android/i.test(ua),ios:/iPhone|iPad|iPod/i.test(ua)};if(result.chrome){const match=ua.match(/Chrome\/(\d+)/);match&&(result.version=parseInt(match[1]))}return result}async function getCameraStreamRobust(){const constraints={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}};if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{return _log.default.debug("Trying modern mediaDevices.getUserMedia"),await navigator.mediaDevices.getUserMedia(constraints)}catch(error){_log.default.debug("Modern API failed:",error)}if(navigator.getUserMedia)try{return _log.default.debug("Trying legacy getUserMedia"),await new Promise(((resolve,reject)=>{navigator.getUserMedia(constraints,resolve,reject)}))}catch(error){_log.default.debug("Legacy getUserMedia failed:",error)}if(navigator.webkitGetUserMedia)try{return _log.default.debug("Trying webkitGetUserMedia"),await new Promise(((resolve,reject)=>{navigator.webkitGetUserMedia(constraints,resolve,reject)}))}catch(error){_log.default.debug("webkitGetUserMedia failed:",error)}if(navigator.mozGetUserMedia)try{return _log.default.debug("Trying mozGetUserMedia"),await new Promise(((resolve,reject)=>{navigator.mozGetUserMedia(constraints,resolve,reject)}))}catch(error){_log.default.debug("mozGetUserMedia failed:",error)}throw new Error("No camera API available")}function showDetailedCompatibilityError(compatibility){let message='<div class="alert alert-danger"><h5><i class="fa fa-exclamation-triangle"></i> Camera Not Supported</h5>';message+=(compatibility.browserInfo.chrome,"Chrome ".concat(compatibility.browserInfo.version||"Unknown")),message+="<br><strong>Mobile:</strong> "+(compatibility.browserInfo.mobile?"Yes":"No"),message+="<br><strong>Secure Context:</strong> "+("https:"===location.protocol?"Yes":"No")+"</p>",message+="<p><strong>Available APIs:</strong></p><ul>",Object.keys(compatibility.apis).forEach((api=>{message+="<li>".concat(api,": ").concat(compatibility.apis[api]?"✓":"✗","</li>")})),message+="</ul>",compatibility.issues.length>0&&(message+="<p><strong>Issues Found:</strong></p><ul>",compatibility.issues.forEach((issue=>{switch(issue){case"insecure_context":message+="<li>Site is not served over HTTPS (required for camera access)</li>";break;case"mobile_no_camera_api":message+="<li>Mobile browser does not support camera API</li>"}})),message+="</ul>"),compatibility.browserInfo.chrome&&compatibility.browserInfo.mobile&&(message+='<div class="mt-3"><strong>Chrome Mobile Solutions:</strong>',message+="<ol>",message+="<li>Ensure Chrome is updated to latest version</li>",message+="<li>Try clearing Chrome cache and data</li>",message+='<li>Check if "Use camera" is enabled in Chrome settings</li>',message+="<li>Try accessing via Chrome Incognito mode</li>",message+="</ol></div>"),message+="</div>",scannerContainer&&(scannerContainer.innerHTML=message)}function determineBarcodeType(barcode){return/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(barcode)?"uuid":/^\d{8,14}$/.test(barcode)?"upc":"unknown"}function processBarcode(barcode){let format=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"unknown";_log.default.debug("Processing barcode:",barcode,"Format:",format);const barcodeType=determineBarcodeType(barcode);_log.default.debug("Determined barcode type:",barcodeType);const processingBtn=document.getElementById("scanner-manual-btn");processingBtn&&(processingBtn.disabled=!0,processingBtn.textContent="Processing..."),updateStatusMessage("Processing ".concat(barcodeType," code: ").concat(barcode,"..."),"info"),processRemoval(barcode,barcodeType).finally((()=>{processingBtn&&(processingBtn.disabled=!1,processingBtn.textContent="Process")}))}async function processRemoval(barcode,barcodeType){if(!window.M||!window.M.cfg)throw new Error("Moodle environment not properly loaded. Please refresh the page.");_log.default.debug("local_equipment/remove-items-scanner: Processing removal request",{barcode:barcode,type:barcodeType,timestamp:(new Date).toISOString()});try{const request={methodname:"local_equipment_validate_removal",args:{barcode:barcode,type:barcodeType}};_log.default.debug("local_equipment/remove-items-scanner: Making AJAX request",request);const response=await _ajax.default.call([request]),data=await response[0];if(_log.default.debug("local_equipment/remove-items-scanner: Raw response received",{response:response,data:data,responseType:typeof data,keys:Object.keys(data||{}),stringified:JSON.stringify(data)}),!data||"object"!=typeof data)throw _log.default.error("local_equipment/remove-items-scanner: Invalid response structure",{response:response,data:data,dataType:typeof data}),new Error("Invalid response from server - expected object, got: "+typeof data);if(_log.default.debug("local_equipment/remove-items-scanner: Complete response analysis",{fullResponse:response,dataObject:data,dataKeys:Object.keys(data),dataValues:Object.values(data),hasSuccessProperty:"success"in data,successValue:data.success,successType:typeof data.success,hasMessageProperty:"message"in data,messageValue:data.message,hasErrorProperty:"error"in data,errorValue:data.error,hasErrorCodeProperty:"error_code"in data,errorCodeValue:data.error_code,hasExceptionProperty:"exception"in data,exceptionValue:data.exception,responseAsString:JSON.stringify(data,null,2)}),!0===data.success)_log.default.debug("local_equipment/remove-items-scanner: Success response received",data),function(data){sessionRemovedCount++,sessionRemovedItems.push({id:data.item_id,uuid:data.uuid,product_name:data.product_name,removal_method:data.removal_method});showSuccessMessage(data.removal_method==="emergency_upc"?"Emergency removal: ".concat(data.product_name," (via UPC)"):"Removed: ".concat(data.product_name)),updateStatusMessage("Successfully removed item: ".concat(data.product_name),"success"),function(){if(document.querySelectorAll(".session-removed-count").forEach((counter=>{counter.textContent=sessionRemovedCount})),sessionItems&&sessionRemovedCount>0){let sessionHtml="<h4>Session Removed Items (".concat(sessionRemovedCount,")</h4>");sessionHtml+='<ul class="list-group">',sessionRemovedItems.forEach((item=>{const methodBadge="emergency_upc"===item.removal_method?'<span class="badge bg-warning">Emergency UPC</span>':'<span class="badge bg-primary">QR Code</span>';sessionHtml+='\n                    <li class="list-group-item d-flex justify-content-between align-items-center">\n                        '.concat(item.product_name," (").concat(item.uuid,")\n                        ").concat(methodBadge,"\n                    </li>\n                ")})),sessionHtml+="</ul>",sessionItems.innerHTML!==sessionHtml&&(sessionItems.innerHTML=sessionHtml)}}(),data.redirect_url&&(window.location.href=data.redirect_url)}(data);else if(!1===data.success)_log.default.debug("local_equipment/remove-items-scanner: Error response received",data),handleRemovalError(data);else{(0,_debugUtils.debugAjaxResponse)("Response missing or invalid success property",data,{Barcode:barcode,"Barcode Type":barcodeType,Function:"processRemoval","All Properties":Object.getOwnPropertyNames(data).join(", ")});let errorMessage="Unknown response format from server",debugInfo=data;data.exception?(errorMessage="Moodle Exception: ".concat(data.exception," - ").concat(data.message||"No message provided"),data.debuginfo&&(errorMessage+=" (Debug: ".concat(data.debuginfo,")"))):data.error?errorMessage="Server Error: ".concat(data.error):data.message&&!data.success?errorMessage="Server Response: ".concat(data.message):(errorMessage=data.message||data.error||"Unknown response format from server",errorMessage+=" (Server returned: ".concat(JSON.stringify(data),")")),handleRemovalError({success:!1,message:errorMessage,error_code:"invalid_response_format",debug_info:debugInfo})}}catch(error){_log.default.error("local_equipment/remove-items-scanner: Exception during removal processing",{error:error.message,stack:error.stack,barcode:barcode,barcodeType:barcodeType,timestamp:(new Date).toISOString()});let errorMessage="Network or server error occurred. ",isKnownError=!1;if(error.message&&error.message.includes("invalidparameter")?(errorMessage="Invalid barcode format provided to server.",isKnownError=!0):error.message&&error.message.includes("nopermissions")?(errorMessage="You do not have permission to remove items.",isKnownError=!0):error.message&&error.message.includes("requireloggedin")?(errorMessage="Please log in to remove items.",isKnownError=!0):error.message&&error.message.includes("webservice")?(errorMessage="Web service error: "+error.message,isKnownError=!0):error.message&&error.message.includes("network")&&(errorMessage="Network connection error. Please check your connection.",isKnownError=!0),!isKnownError){document.body.classList.contains("debug")||window.M&&window.M.cfg&&window.M.cfg.developerdebug?errorMessage="Exception: "+error.message+" (Check browser console for details)":errorMessage+="Please contact administrator if this persists."}_notification.default.addNotification({message:errorMessage,type:"error"}),updateStatusMessage(errorMessage,"danger")}}function handleRemovalError(data){let errorMessage=data.message||"Removal failed";switch(data.error_code){case"item_not_found":errorMessage="Equipment item not found: ".concat(data.barcode);break;case"already_removed":errorMessage="Item has already been removed: ".concat(data.product_name);break;case"upc_with_qr_exists":errorMessage="This item has a QR code. Please scan the QR code instead of the UPC barcode to remove it.";break;case"item_checked_out":errorMessage="Cannot remove item that is currently checked out to: ".concat(data.current_user);break;case"invalid_barcode_type":errorMessage="Invalid barcode format. Please scan a valid QR code or UPC barcode.";break;default:errorMessage=data.message||"Unknown removal error occurred"}if(showErrorMessage(errorMessage),updateStatusMessage(errorMessage,"danger"),data.manual_removal_url){const alert=document.querySelector(".alert:last-child");alert&&(alert.innerHTML+=' <a href="'.concat(data.manual_removal_url,'" class="alert-link">Remove manually</a>'))}}function updateStatusMessage(message){let alertType=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",statusContainer=document.getElementById("scanner-status-message");statusContainer||(statusContainer=document.createElement("div"),statusContainer.id="scanner-status-message",statusContainer.className="mt-3",scannerContainer&&scannerContainer.parentNode&&scannerContainer.parentNode.insertBefore(statusContainer,scannerContainer.nextSibling));const alertClass="alert alert-".concat(alertType);statusContainer.innerHTML='\n            <div class="'.concat(alertClass,'">\n                <i class="fa fa-info-circle me-2"></i>\n                ').concat(message,"\n            </div>\n        "),"info"===alertType&&setTimeout((()=>{statusContainer.innerHTML.includes(message)&&(statusContainer.innerHTML="")}),5e3)}function showSuccessMessage(message){const alert=document.createElement("div");alert.className="alert alert-success alert-dismissible fade show mt-2",alert.innerHTML="\n            <strong>✓ Success!</strong> ".concat(message,'\n            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n        '),sessionItems?sessionItems.appendChild(alert):scannerContainer&&scannerContainer.appendChild(alert),setTimeout((()=>{alert.parentNode&&alert.remove()}),3e3)}function showErrorMessage(message){let actionUrl=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const alert=document.createElement("div");alert.className="alert alert-danger alert-dismissible fade show mt-2";let content="<strong>✗ Error:</strong> ".concat(message);actionUrl&&(content+=' <a href="'.concat(actionUrl,'" class="alert-link">Take action</a>')),content+='<button type="button" class="btn-close" data-bs-dismiss="alert"></button>',alert.innerHTML=content,sessionItems?sessionItems.appendChild(alert):scannerContainer&&scannerContainer.appendChild(alert)}initScanner(),lookupBtn&&lookupBtn.addEventListener("click",(function(){const uuid=manualUuid.value.trim();uuid&&(processBarcode(uuid,"manual"),manualUuid.value="")})),manualUuid&&manualUuid.addEventListener("keypress",(function(e){"Enter"===e.key&&lookupBtn.click()}))}_exports.init=()=>{_log.default.debug("local_equipment/remove-items-scanner: init() called"),_log.default.debug("local_equipment/remove-items-scanner: document.readyState =",document.readyState),"loading"===document.readyState?(_log.default.debug("local_equipment/remove-items-scanner: DOM still loading, adding DOMContentLoaded listener"),document.addEventListener("DOMContentLoaded",(function(){_log.default.debug("local_equipment/remove-items-scanner: DOMContentLoaded event fired"),initializeScanner()}))):(_log.default.debug("local_equipment/remove-items-scanner: DOM already ready, initializing immediately"),initializeScanner())}}));

//# sourceMappingURL=remove-items-scanner.min.js.map