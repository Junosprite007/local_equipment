define("local_equipment/mass_text_dynamic_form",["exports","core/ajax","core/notification","core/str","core_form/modalform","core/toast","core/log"],(function(_exports,_ajax,_notification,_str,_modalform,_toast,_log){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Mass text dynamic form JavaScript functionality.
   *
   * @module     local_equipment/mass_text_dynamic_form
   * @copyright  2025 onwards Joshua Kirby <josh@funlearningcompany.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification),_modalform=_interopRequireDefault(_modalform),_log=_interopRequireDefault(_log);var _default={init:()=>{let retryCount=0;const initializeForm=()=>{const messageTextarea=document.querySelector('textarea[name="message"]')||document.querySelector("#id_message")||document.querySelector('textarea[id*="message"]'),charCountDisplay=document.querySelector("#char-counter")||document.querySelector('[id*="char-counter"]')||document.querySelector(".char-counter"),recipientCountDisplay=document.querySelector("#recipient-count")||document.querySelector('[id*="recipient-count"]')||document.querySelector(".recipient-count"),form=document.querySelector("form");if(!messageTextarea)return retryCount++,retryCount<50?(_log.default.debug("local_equipment/mass_text_dynamic_form: Message textarea not found, retrying... (".concat(retryCount,"/").concat(50,")")),void setTimeout(initializeForm,100)):void _log.default.error("local_equipment/mass_text_dynamic_form: Message textarea not found after maximum retries. Form initialization failed.");_log.default.debug("local_equipment/mass_text_dynamic_form: Elements found, initializing...");const maxLength=parseInt(messageTextarea.dataset.maxLength)||250,updateCharCount=()=>{const currentLength=messageTextarea.value.length,remaining=maxLength-currentLength;charCountDisplay.textContent=remaining>=0?"".concat(remaining," characters remaining"):"".concat(Math.abs(remaining)," characters over limit"),charCountDisplay.classList.remove("text-danger","text-warning","text-muted"),remaining<0?charCountDisplay.classList.add("text-danger"):remaining<20?charCountDisplay.classList.add("text-warning"):charCountDisplay.classList.add("text-muted")},loadRecipientCount=()=>{recipientCountDisplay&&_ajax.default.call([{methodname:"local_equipment_get_recipient_count",args:{}}])[0].then((response=>{_log.default.debug("Web service response:",response),response.success?(recipientCountDisplay.textContent="".concat(response.count," parents"),recipientCountDisplay.className="badge bg-secondary",0===response.count?(recipientCountDisplay.classList.remove("bg-secondary"),recipientCountDisplay.classList.add("bg-warning")):(recipientCountDisplay.classList.remove("bg-warning"),recipientCountDisplay.classList.add("bg-success"))):(recipientCountDisplay.textContent="Error loading count",recipientCountDisplay.className="badge bg-danger",_log.default.error("local_equipment/mass_text_dynamic_form: Recipient count error:",response.error))})).catch((error=>{_log.default.debug("Web service error details:",error),recipientCountDisplay.textContent="Error loading count",recipientCountDisplay.className="badge bg-danger",_log.default.error("local_equipment/mass_text_dynamic_form: Web service error:",error.message||"Unknown error")}))},showErrorDetails=errorDetails=>{let errorHtml='<div class="alert alert-danger mt-3">';errorHtml+="<h5>Error Details</h5>",errorHtml+='<div class="collapse" id="errorDetails">',errorHtml+='<ul class="mb-0">',errorDetails.forEach((error=>{errorHtml+="<li>",errorHtml+="<strong>".concat(error.recipient,"</strong> (").concat(error.phone,"): "),errorHtml+=error.error_message,error.aws_error_code&&(errorHtml+=" (AWS Error: ".concat(error.aws_error_code,")")),errorHtml+="</li>"})),errorHtml+="</ul>",errorHtml+="</div>",errorHtml+='<button class="btn btn-sm btn-outline-danger mt-2" type="button"\n                      data-bs-toggle="collapse" data-bs-target="#errorDetails"\n                      aria-expanded="false" aria-controls="errorDetails">',errorHtml+="View Error Details (".concat(errorDetails.length," errors)"),errorHtml+="</button>",errorHtml+="</div>";const formContainer=document.querySelector(".local_equipment_mass_text")||document.querySelector("form")||document.body,errorDiv=document.createElement("div");errorDiv.innerHTML=errorHtml,formContainer.appendChild(errorDiv)},handleFormSubmit=e=>{const message=messageTextarea.value.trim();return 0===message.length?(e.preventDefault(),_notification.default.addNotification({message:"Please enter a message",type:"error"}),!1):message.length>maxLength?(e.preventDefault(),_notification.default.addNotification({message:"Message is too long. Maximum ".concat(maxLength," characters allowed"),type:"error"}),!1):!!confirm("Are you sure you want to send this message to all parents?")||(e.preventDefault(),!1)};messageTextarea.addEventListener("input",(()=>{charCountDisplay&&updateCharCount()})),messageTextarea.addEventListener("keyup",(()=>{charCountDisplay&&updateCharCount()})),messageTextarea.addEventListener("paste",(()=>{setTimeout((()=>{charCountDisplay&&updateCharCount()}),10)})),charCountDisplay&&updateCharCount(),loadRecipientCount(),form&&form.addEventListener("submit",handleFormSubmit);document.querySelectorAll('[data-action="mass-text-modal"]').forEach((trigger=>{trigger.addEventListener("click",(e=>{e.preventDefault();const modalForm=new _modalform.default({formClass:"local_equipment\\form\\mass_text_dynamic_form",args:{},modalConfig:{title:(0,_str.get_string)("masstextmessaging","local_equipment"),size:"lg"},returnFocus:trigger});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(e=>{var response;(response=e.detail).success_message&&(0,_toast.add)(response.success_message,{type:"success",autohide:!0,delay:5e3}),response.failure_message&&(0,_toast.add)(response.failure_message,{type:"warning",autohide:!0,delay:8e3}),response.error_details&&response.error_details.length>0&&showErrorDetails(response.error_details),messageTextarea&&(messageTextarea.value="",updateCharCount()),loadRecipientCount()})),modalForm.show()}))}))};initializeForm()}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=mass_text_dynamic_form.min.js.map