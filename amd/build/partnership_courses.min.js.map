{"version":3,"file":"partnership_courses.min.js","sources":["../src/partnership_courses.js"],"sourcesContent":["// This file is part of FLIP Plugins for Moodle\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * JavaScript for managing consents.\n *\n * @module     local_equipment/partnership_courses\n * @copyright  2024 Joshua Kirby <josh@funlearningcompany.com>\n * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Log from 'core/log';\nimport { get_string as getString } from 'core/str';\n\nexport const init = () => {\n    Log.debug('init function called in partnership_courses.js');\n\n    const partnershipSelect = document.getElementById('id_partnership');\n\n    if (!partnershipSelect) {\n        Log.error('partnershipSelect element not found');\n        return;\n    } else {\n        Log.debug(\"'partnershipSelect' variable: \");\n        Log.debug(partnershipSelect);\n    }\n\n    let partnershipData;\n    try {\n        partnershipData = JSON.parse(\n            partnershipSelect.getAttribute('data-partnerships') || '{}'\n        );\n        Log.debug(\"'partnershipData' variable: \");\n        Log.debug(partnershipData);\n    } catch (e) {\n        Log.error('Error parsing partnership data: ', e);\n        return;\n    }\n    // Use async/await for better readability and error handling\n    const updateStudentCourses = async (partnershipId) => {\n        Log.debug(\n            'updateStudentCourses function called in partnership_courses.js'\n        );\n        Log.debug('partnershipId argument passed in: ');\n        Log.debug(partnershipId);\n\n        const courses = partnershipData[partnershipId] || [];\n        Log.debug(\"'courses' variable: \");\n        Log.debug(courses);\n\n        const selects = document.querySelectorAll(\n            'select[name^=\"student_courses[\"]'\n        );\n        Log.debug(\"'selects' variable: \");\n        Log.debug(selects);\n        for (const select of selects) {\n            await updateCourseOptions(select, courses);\n        }\n    };\n\n    // Change: Modified to handle previously selected courses\n    const updateCourseOptions = async (select, courses) => {\n        Log.debug(\n            'updateCourseOptions function called in partnership_courses.js'\n        );\n        Log.debug(\"'select' arg passed: \");\n        Log.debug(select);\n        Log.debug(\"'courses' arg passed: \");\n        Log.debug(courses);\n\n        // Retrieve previously selected courses\n        const previouslySelected = JSON.parse(\n            select.getAttribute('data-selected') || '[]'\n        );\n        Log.debug(\"'previouslySelected' variable: \");\n        Log.debug(previouslySelected);\n\n        select.innerHTML = '';\n        if (courses.length === 0) {\n            Log.debug('courses length is 0...');\n            const noCourseString = await getString(\n                'nocoursesavailable',\n                'local_equipment'\n            );\n            const option = document.createElement('option');\n            option.value = '';\n            option.textContent = noCourseString;\n            option.disabled = true;\n            select.appendChild(option);\n\n            Log.debug(\"'noCourseString' variable: \");\n            Log.debug(noCourseString);\n            Log.debug(\"'option' variable: \");\n            Log.debug(option);\n        } else {\n            Log.debug('courses length is not 0...');\n            courses.forEach((course) => {\n                const option = document.createElement('option');\n                option.value = course.id;\n                option.textContent = course.fullname;\n                // Restore previously selected state\n                option.selected = previouslySelected.includes(\n                    course.id.toString()\n                );\n                select.appendChild(option);\n\n                Log.debug(\"'option' variable: \");\n                Log.debug(option);\n            });\n        }\n        // Call preserveSelectedCourses after updating options\n        preserveSelectedCourses();\n    };\n\n    // New function: Preserve selected courses\n    const preserveSelectedCourses = () => {\n        Log.debug(\n            'preserveSelectedCourses function called in partnership_courses.js'\n        );\n        document\n            .querySelectorAll('select[name^=\"student_courses[\"]')\n            .forEach((select) => {\n                select.addEventListener('change', () => {\n                    const selectedOptions = Array.from(\n                        select.selectedOptions\n                    ).map((option) => option.value);\n                    select.setAttribute(\n                        'data-selected',\n                        JSON.stringify(selectedOptions)\n                    );\n                    Log.debug(\"'option' variable: \");\n                    Log.debug(selectedOptions);\n                });\n            });\n    };\n\n    partnershipSelect.addEventListener('change', (event) => {\n        updateStudentCourses(event.target.value);\n    });\n\n    // Initial update\n    updateStudentCourses(partnershipSelect.value);\n\n    // Call preserveSelectedCourses initially\n    preserveSelectedCourses();\n\n    Log.debug('###### End init function for partnership_courses.js ######');\n};\n"],"names":["debug","partnershipSelect","document","getElementById","error","partnershipData","JSON","parse","getAttribute","e","updateStudentCourses","async","partnershipId","courses","selects","querySelectorAll","select","updateCourseOptions","previouslySelected","innerHTML","length","noCourseString","option","createElement","value","textContent","disabled","appendChild","forEach","course","id","fullname","selected","includes","toString","preserveSelectedCourses","addEventListener","selectedOptions","Array","from","map","setAttribute","stringify","event","target"],"mappings":";;;;;;;kJA0BoB,kBACZA,MAAM,wDAEJC,kBAAoBC,SAASC,eAAe,sBAE7CF,2CACGG,MAAM,2CAOVC,6BAJIL,MAAM,+CACNA,MAAMC,uBAKVI,gBAAkBC,KAAKC,MACnBN,kBAAkBO,aAAa,sBAAwB,mBAEvDR,MAAM,6CACNA,MAAMK,iBACZ,MAAOI,4BACDL,MAAM,mCAAoCK,SAI5CC,qBAAuBC,MAAAA,6BACrBX,MACA,+EAEAA,MAAM,mDACNA,MAAMY,qBAEJC,QAAUR,gBAAgBO,gBAAkB,gBAC9CZ,MAAM,qCACNA,MAAMa,eAEJC,QAAUZ,SAASa,iBACrB,iDAEAf,MAAM,qCACNA,MAAMc,aACL,MAAME,UAAUF,cACXG,oBAAoBD,OAAQH,UAKpCI,oBAAsBN,MAAOK,OAAQH,wBACnCb,MACA,8EAEAA,MAAM,sCACNA,MAAMgB,qBACNhB,MAAM,uCACNA,MAAMa,eAGJK,mBAAqBZ,KAAKC,MAC5BS,OAAOR,aAAa,kBAAoB,sBAExCR,MAAM,gDACNA,MAAMkB,oBAEVF,OAAOG,UAAY,GACI,IAAnBN,QAAQO,OAAc,cAClBpB,MAAM,gCACJqB,qBAAuB,mBACzB,qBACA,mBAEEC,OAASpB,SAASqB,cAAc,UACtCD,OAAOE,MAAQ,GACfF,OAAOG,YAAcJ,eACrBC,OAAOI,UAAW,EAClBV,OAAOW,YAAYL,qBAEftB,MAAM,4CACNA,MAAMqB,6BACNrB,MAAM,oCACNA,MAAMsB,0BAENtB,MAAM,8BACVa,QAAQe,SAASC,eACPP,OAASpB,SAASqB,cAAc,UACtCD,OAAOE,MAAQK,OAAOC,GACtBR,OAAOG,YAAcI,OAAOE,SAE5BT,OAAOU,SAAWd,mBAAmBe,SACjCJ,OAAOC,GAAGI,YAEdlB,OAAOW,YAAYL,qBAEftB,MAAM,oCACNA,MAAMsB,WAIlBa,2BAIEA,wBAA0B,kBACxBnC,MACA,qEAEJE,SACKa,iBAAiB,oCACjBa,SAASZ,SACNA,OAAOoB,iBAAiB,UAAU,WACxBC,gBAAkBC,MAAMC,KAC1BvB,OAAOqB,iBACTG,KAAKlB,QAAWA,OAAOE,QACzBR,OAAOyB,aACH,gBACAnC,KAAKoC,UAAUL,+BAEfrC,MAAM,oCACNA,MAAMqC,wBAK1BpC,kBAAkBmC,iBAAiB,UAAWO,QAC1CjC,qBAAqBiC,MAAMC,OAAOpB,UAItCd,qBAAqBT,kBAAkBuB,OAGvCW,uCAEInC,MAAM"}