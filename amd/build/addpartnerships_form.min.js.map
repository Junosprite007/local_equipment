{"version":3,"file":"addpartnerships_form.min.js","sources":["../src/addpartnerships_form.js"],"sourcesContent":["// This file is part of FLIP Plugins for Moodle\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * JavaScript for the add partnerships form.\n *\n * @module     local_equipment/addpartnerships_form\n * @copyright  2024 Joshua Kirby <josh@funlearningcompany.com>\n * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport { get_string as getString } from 'core/str';\nimport Log from 'core/log';\n\n/**\n * Initialize the add partnerships form functionality.\n */\nexport const init = () => {\n    Log.debug('Add Partnership Form JS initialized');\n    setupPartnershipsHandling();\n};\n\n/**\n * Set up partnerships handling.\n */\nconst setupPartnershipsHandling = () => {\n    const selector = \"fieldset[id^='id_partnershipheader_']\";\n\n    $(document).on('click', '.local-equipment-remove-partnership', function () {\n        const $fieldset = $(this).closest(selector);\n        const $select = $fieldset.find(\n            \"select[id^='id_partnershipcourselist_']\"\n        );\n        const containerId = $select\n            .attr('id')\n            .replace('partnershipcourselist', 'courses');\n        $(`#${containerId}`).remove();\n\n        $fieldset.remove();\n        updatePartnershipNumbers();\n        updateHiddenFields();\n        renumberFormElements();\n        updateTrashIcons();\n    });\n\n    updateTrashIcons();\n};\n\n/**\n * Update partnership numbers.\n */\nconst updatePartnershipNumbers = () => {\n    $('.local-equipment-partnership-header').each((index, element) => {\n        getString('partnership', 'local_equipment', index + 1)\n            .then((string) => {\n                $(element).text(string);\n            })\n            .catch((error) => {\n                Log.error('Error updating partnership header:', error);\n            });\n    });\n};\n\n/**\n * Update hidden fields.\n */\nconst updateHiddenFields = () => {\n    const partnershipsCount = $(\"fieldset[id^='id_partnershipheader_']\").length;\n    $('input[name=\"partnerships\"]').val(partnershipsCount);\n\n    // Update the URL if necessary\n    const url = new URL(window.location.href);\n    url.searchParams.set('repeatno', partnershipsCount);\n    window.history.replaceState({}, '', url);\n};\n\n/**\n * Renumber form elements.\n */\nconst renumberFormElements = () => {\n    $(\"fieldset[id^='id_partnershipheader_']\").each((index, fieldset) => {\n        $(fieldset)\n            .find('input, select, textarea')\n            .each((_, element) => {\n                const name = $(element).attr('name');\n                if (name) {\n                    const newName = name.replace(/\\[\\d+\\]/, `[${index}]`);\n                    $(element).attr('name', newName);\n                }\n                const id = $(element).attr('id');\n                if (id) {\n                    const newId = id.replace(/_\\d+_/, `_${index}_`);\n                    $(element).attr('id', newId);\n                }\n            });\n    });\n};\n\n/**\n * Update trash icons visibility.\n */\nconst updateTrashIcons = () => {\n    const partnerships = $(\"fieldset[id^='id_partnershipheader_']\");\n    if (partnerships.length > 1) {\n        $('.local-equipment-remove-partnership').show();\n    } else {\n        $('.local-equipment-remove-partnership').hide();\n    }\n};\n\n/**\n * Display course listings for partnership dropdowns\n */\nexport const displayPartnershipCourseListing = () => {\n    const coursesData = JSON.parse(\n        $('#id_coursesthisyear').attr('data-coursesthisyear')\n    );\n\n    /**\n     * Create course listing for a specific partnership dropdown\n     * @param {jQuery} $select The partnership select element\n     */\n    const initializePartnershipSelect = async ($select) => {\n        // Create unique container for this partnership's courses\n        const containerId = $select\n            .attr('id')\n            .replace('partnershipcourselist', 'courses');\n        let $container = $(`#${containerId}`);\n\n        // If container doesn't exist, create it\n        if (!$container.length) {\n            $container = $('<div>', {\n                id: containerId,\n                class: 'local-equipment_partnership-courses-container mt-3',\n            });\n            $select.after($container);\n        }\n\n        // Get required strings\n        const strings = await Promise.all([\n            getString('nocoursesfoundforthispartnership', 'local_equipment'),\n            getString('courseid', 'local_equipment'),\n            getString('coursename', 'local_equipment'),\n            getString('totalcourses', 'local_equipment'),\n        ]);\n\n        const [\n            noCoursesFound,\n            courseIdLabel,\n            courseNameLabel,\n            totalCoursesLabel,\n        ] = strings;\n\n        /**\n         * Display courses for the selected partnership\n         * @param {string} partnershipId The selected partnership ID\n         */\n        const displayCourses = (partnershipId) => {\n            $container.empty();\n\n            const partnershipCourses = coursesData[partnershipId];\n\n            if (\n                !partnershipCourses ||\n                Object.keys(partnershipCourses).length === 0\n            ) {\n                $container.html(\n                    `<div class=\"alert alert-warning\">${noCoursesFound}</div>`\n                );\n                // return;\n            }\n\n            // Create main container with fixed height layout\n            const $mainContainer = $('<div>').addClass(\n                'local-equipment_main-courses-container'\n            );\n\n            // Create fixed header\n            const $header = $('<div>')\n                .addClass('local-equipment_courses-header')\n                .append(\n                    $('<div>')\n                        .addClass('local-equipment_courses-header-row d-flex')\n                        .append(\n                            $('<div>')\n                                .addClass('local-equipment_course-id-col')\n                                .text(courseIdLabel),\n                            $('<div>')\n                                .addClass('local-equipment_course-name-col')\n                                .text(courseNameLabel)\n                        )\n                );\n\n            // Create scrollable content area\n            const $scrollContent = $('<div>').addClass(\n                'local-equipment_courses-scroll-content'\n            );\n            const $scrollTable = $('<div>').addClass(\n                'local-equipment_courses-table'\n            );\n\n            // Sort and add courses\n            const sortedCourseIds = Object.keys(partnershipCourses).sort(\n                (a, b) => parseInt(a) - parseInt(b)\n            );\n\n            sortedCourseIds.forEach((courseId) => {\n                $('<div>')\n                    .addClass('local-equipment_course-row d-flex')\n                    .append(\n                        $('<div>')\n                            .addClass('local-equipment_course-id-col')\n                            .text(courseId),\n                        $('<div>')\n                            .addClass('local-equipment_course-name-col')\n                            .text(partnershipCourses[courseId])\n                    )\n                    .appendTo($scrollTable);\n            });\n\n            $scrollContent.append($scrollTable);\n\n            // Create fixed footer\n            const $footer = $('<div>')\n                .addClass('local-equipment_courses-footer')\n                .text(`${totalCoursesLabel}: ${sortedCourseIds.length}`);\n\n            // Assemble the structure\n            $mainContainer\n                .append($header)\n                .append($scrollContent)\n                .append($footer);\n\n            $container.append($mainContainer);\n        };\n\n        // Handle changes to this select\n        $select.on('change', function () {\n            const selectedPartnership = $(this).val();\n            if (selectedPartnership) {\n                displayCourses(selectedPartnership);\n            } else {\n                $container.empty();\n            }\n        });\n\n        // Display initial courses if pre-selected\n        const initialPartnership = $select.val();\n        if (initialPartnership) {\n            displayCourses(initialPartnership);\n        }\n    };\n\n    // Initialize all existing partnership selects\n    $(\"select[id^='id_partnershipcourselist_']\").each(function () {\n        initializePartnershipSelect($(this));\n    });\n\n    // Handle newly added partnerships\n    $(document).on('click', '[name=\"addpartnership\"]', function () {\n        // Wait for DOM to update\n        setTimeout(() => {\n            const $newSelect = $(\n                \"select[id^='id_partnershipcourselist_']:last\"\n            );\n            if ($newSelect.length) {\n                initializePartnershipSelect($newSelect);\n            }\n        }, 100);\n    });\n};\n"],"names":["debug","setupPartnershipsHandling","document","on","$fieldset","this","closest","containerId","find","attr","replace","remove","updatePartnershipNumbers","updateHiddenFields","renumberFormElements","updateTrashIcons","each","index","element","then","string","text","catch","error","partnershipsCount","length","val","url","URL","window","location","href","searchParams","set","history","replaceState","fieldset","_","name","newName","id","newId","show","hide","coursesData","JSON","parse","initializePartnershipSelect","async","$select","$container","class","after","strings","Promise","all","noCoursesFound","courseIdLabel","courseNameLabel","totalCoursesLabel","displayCourses","partnershipId","empty","partnershipCourses","Object","keys","html","$mainContainer","addClass","$header","append","$scrollContent","$scrollTable","sortedCourseIds","sort","a","b","parseInt","forEach","courseId","appendTo","$footer","selectedPartnership","initialPartnership","setTimeout","$newSelect"],"mappings":"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"}